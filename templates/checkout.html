<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - WoodNook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <strong>ðŸªµ WoodNook</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('products') }}">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('about') }}">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('contact') }}">Contact</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    {% if current_user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('cart') }}">
                                ðŸ›’ Cart ({{ cart_count }})
                            </a>
                        </li>
                        {% if current_user.is_admin %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin_dashboard') }}">Admin</a>
                            </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('logout') }}">Logout ({{ current_user.full_name }})</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('login') }}">Login</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2>Checkout</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('cart') }}">Cart</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                    </ol>
                </nav>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" id="checkoutForm">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Shipping Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="shipping_name" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="shipping_name" name="shipping_name" 
                                               value="{{ current_user.full_name }}" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="shipping_email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="shipping_email" name="shipping_email" 
                                               value="{{ current_user.email }}" required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="shipping_phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="shipping_phone" name="shipping_phone" 
                                       pattern="[0-9]{10}" maxlength="10" placeholder="9876543210" required>
                            </div>
                            <div class="mb-3">
                                <label for="shipping_address" class="form-label">Address</label>
                                <input type="text" class="form-control" id="shipping_address" name="shipping_address" 
                                       placeholder="123 Main Street, Sector 1" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="shipping_city" class="form-label">City</label>
                                        <input type="text" class="form-control" id="shipping_city" name="shipping_city" required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="shipping_state" class="form-label">State</label>
                                        <select class="form-select" id="shipping_state" name="shipping_state" required>
                                            <option value="">Select State</option>
                                            <option value="AN">Andaman and Nicobar Islands</option>
                                            <option value="AP">Andhra Pradesh</option>
                                            <option value="AR">Arunachal Pradesh</option>
                                            <option value="AS">Assam</option>
                                            <option value="BR">Bihar</option>
                                            <option value="CH">Chandigarh</option>
                                            <option value="CT">Chhattisgarh</option>
                                            <option value="DN">Dadra and Nagar Haveli</option>
                                            <option value="DD">Daman and Diu</option>
                                            <option value="DL">Delhi</option>
                                            <option value="GA">Goa</option>
                                            <option value="GJ">Gujarat</option>
                                            <option value="HR">Haryana</option>
                                            <option value="HP">Himachal Pradesh</option>
                                            <option value="JK">Jammu and Kashmir</option>
                                            <option value="JH">Jharkhand</option>
                                            <option value="KA">Karnataka</option>
                                            <option value="KL">Kerala</option>
                                            <option value="LA">Ladakh</option>
                                            <option value="LD">Lakshadweep</option>
                                            <option value="MP">Madhya Pradesh</option>
                                            <option value="MH">Maharashtra</option>
                                            <option value="MN">Manipur</option>
                                            <option value="ML">Meghalaya</option>
                                            <option value="MZ">Mizoram</option>
                                            <option value="NL">Nagaland</option>
                                            <option value="OR">Odisha</option>
                                            <option value="PY">Puducherry</option>
                                            <option value="PB">Punjab</option>
                                            <option value="RJ">Rajasthan</option>
                                            <option value="SK">Sikkim</option>
                                            <option value="TN">Tamil Nadu</option>
                                            <option value="TG">Telangana</option>
                                            <option value="TR">Tripura</option>
                                            <option value="UP">Uttar Pradesh</option>
                                            <option value="UT">Uttarakhand</option>
                                            <option value="WB">West Bengal</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="shipping_zip" class="form-label">PIN Code</label>
                                        <input type="text" class="form-control" id="shipping_zip" name="shipping_zip" 
                                               pattern="[0-9]{6}" maxlength="6" placeholder="110001" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Payment Information</h5>
                        </div>
                        <div class="card-body">
                            <!-- Payment Method Selection -->
                            <div class="mb-4">
                                <label class="form-label">Select Payment Method</label>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card payment-method" onclick="selectPaymentMethod('upi')">
                                            <div class="card-body text-center">
                                                <i class="fas fa-mobile-alt fa-2x text-primary mb-2"></i>
                                                <h6>UPI Payment</h6>
                                                <small class="text-muted">Pay using Google Pay, PhonePe, Paytm</small>
                                                <input type="radio" name="payment_method" value="upi" id="upi" class="d-none">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card payment-method" onclick="selectPaymentMethod('cod')">
                                            <div class="card-body text-center">
                                                <i class="fas fa-money-bill-wave fa-2x text-secondary mb-2"></i>
                                                <h6>Cash on Delivery</h6>
                                                <small class="text-muted">Pay when you receive</small>
                                                <input type="radio" name="payment_method" value="cod" id="cod" class="d-none">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Details Section (Initially Hidden) -->
                            <div id="payment-details" class="d-none">
                                <div id="upi-details" class="payment-details d-none">
                                    <div class="mb-3">
                                        <label for="upi_id" class="form-label">UPI ID</label>
                                        <input type="text" class="form-control" id="upi_id" name="upi_id" 
                                               placeholder="yourname@paytm or yourname@googlepay">
                                    </div>
                                </div>

                                <div id="cod-details" class="payment-details d-none">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Cash on Delivery:</strong> You will pay â‚¹{{ "%.2f"|format(total) }} when the order is delivered.
                                        <br><small>Please keep exact change ready. COD charges of â‚¹25 apply for orders below â‚¹500.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>Order Summary</h5>
                        </div>
                        <div class="card-body">
                            {% for item in cart_items %}
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="d-flex align-items-center">
                                    <img src="{{ url_for('static', filename=item.product.image_url) if item.product.image_url else url_for('static', filename='images/placeholder-product.jpg') }}" 
                                         alt="{{ item.product.name }}" class="product-thumbnail me-2">
                                    <div>
                                        <h6 class="mb-0">{{ item.product.name }}</h6>
                                        <small class="text-muted">Qty: {{ item.quantity }}</small>
                                    </div>
                                </div>
                                <span>â‚¹{{ "%.2f"|format(item.product.price * item.quantity) }}</span>
                            </div>
                            {% endfor %}
                            
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span>Subtotal:</span>
                                <span>â‚¹{{ "%.2f"|format(subtotal) }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Shipping:</span>
                                <span>â‚¹{{ "%.2f"|format(shipping) }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>GST (18%):</span>
                                <span>â‚¹{{ "%.2f"|format(tax) }}</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>Total:</strong>
                                <strong>â‚¹{{ "%.2f"|format(total) }}</strong>
                            </div>
                            
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    Place Order - â‚¹{{ "%.2f"|format(total) }}
                                </button>
                                <a href="{{ url_for('cart') }}" class="btn btn-outline-secondary">
                                    Back to Cart
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>ðŸªµ WoodNook</h5>
                    <p>Handcrafted Wooden Toys & DÃ©cor</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>&copy; 2024 WoodNook. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Format card number input
        document.getElementById('card_number').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Format expiry date input
        document.getElementById('card_expiry').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        // Only allow numbers for CVV
        document.getElementById('card_cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // Only allow numbers for PIN Code (6 digits)
        document.getElementById('shipping_zip').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // Format and validate phone number (10 digits)
        document.getElementById('shipping_phone').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // Form validation
        document.getElementById('checkoutForm').addEventListener('submit', function(e) {
            const cardNumber = document.getElementById('card_number').value.replace(/\s/g, '');
            const cardExpiry = document.getElementById('card_expiry').value;
            const cardCvv = document.getElementById('card_cvv').value;
            const phone = document.getElementById('shipping_phone').value;
            const pinCode = document.getElementById('shipping_zip').value;

            if (cardNumber.length < 13) {
                alert('Please enter a valid card number');
                e.preventDefault();
                return;
            }

            if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                alert('Please enter a valid expiry date (MM/YY)');
                e.preventDefault();
                return;
            }

            if (cardCvv.length < 3) {
                alert('Please enter a valid CVV');
                e.preventDefault();
                return;
            }

            if (phone.length !== 10) {
                alert('Please enter a valid 10-digit phone number');
                e.preventDefault();
                return;
            }

            if (pinCode.length !== 6) {
                alert('Please enter a valid 6-digit PIN code');
                e.preventDefault();
                return;
            }

            // Check if payment method is selected
            const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
            if (!paymentMethod) {
                alert('Please select a payment method');
                e.preventDefault();
                return;
            }

            // Validate payment method specific fields
            if (paymentMethod.value === 'upi') {
                const upiId = document.getElementById('upi_id').value;
                if (!upiId || !upiId.includes('@')) {
                    alert('Please enter a valid UPI ID');
                    e.preventDefault();
                    return;
                }
            } else if (paymentMethod.value === 'netbanking') {
                const bank = document.getElementById('bank').value;
                if (!bank) {
                    alert('Please select a bank');
                    e.preventDefault();
                    return;
                }
            } else if (paymentMethod.value === 'debit_card' || paymentMethod.value === 'credit_card') {
                const cardNumber = document.getElementById('card_number').value;
                const cardExpiry = document.getElementById('card_expiry').value;
                const cardCvv = document.getElementById('card_cvv').value;
                const cardName = document.getElementById('card_name').value;

                if (!cardNumber || cardNumber.length < 16) {
                    alert('Please enter a valid card number');
                    e.preventDefault();
                    return;
                }
                if (!cardExpiry || !cardExpiry.match(/^\d{2}\/\d{2}$/)) {
                    alert('Please enter expiry date in MM/YY format');
                    e.preventDefault();
                    return;
                }
                if (!cardCvv || cardCvv.length < 3) {
                    alert('Please enter a valid CVV');
                    e.preventDefault();
                    return;
                }
                if (!cardName) {
                    alert('Please enter name on card');
                    e.preventDefault();
                    return;
                }
            } else if (paymentMethod.value === 'wallet') {
                const walletType = document.getElementById('wallet_type').value;
                const walletMobile = document.getElementById('wallet_mobile').value;
                if (!walletType) {
                    alert('Please select a wallet');
                    e.preventDefault();
                    return;
                }
                if (!walletMobile || walletMobile.length !== 10) {
                    alert('Please enter a valid mobile number');
                    e.preventDefault();
                    return;
                }
            }
        });

        // Payment method selection functionality
        function selectPaymentMethod(method) {
            // Remove active class from all payment methods
            document.querySelectorAll('.payment-method').forEach(card => {
                card.classList.remove('border-primary', 'bg-light');
            });

            // Add active class to selected method
            event.target.closest('.payment-method').classList.add('border-primary', 'bg-light');

            // Check the radio button
            document.getElementById(method).checked = true;

            // Show payment details section
            document.getElementById('payment-details').classList.remove('d-none');

            // Hide all payment detail sections
            document.querySelectorAll('.payment-details').forEach(section => {
                section.classList.add('d-none');
            });

            // Show relevant payment details
            if (method === 'upi') {
                document.getElementById('upi-details').classList.remove('d-none');
            } else if (method === 'cod') {
                document.getElementById('cod-details').classList.remove('d-none');
            }
        }

        // Format card number input
        document.addEventListener('DOMContentLoaded', function() {
            const cardNumberInput = document.getElementById('card_number');
            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
                    e.target.value = value;
                });
            }

            const cardExpiryInput = document.getElementById('card_expiry');
            if (cardExpiryInput) {
                cardExpiryInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });
            }
        });

        // Add hover effects to payment methods
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.payment-method').forEach(card => {
                card.style.cursor = 'pointer';
                card.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('border-primary')) {
                        this.classList.add('border-secondary');
                    }
                });
                card.addEventListener('mouseleave', function() {
                    this.classList.remove('border-secondary');
                });
            });
        });
        });
    </script>
</body>
</html>
